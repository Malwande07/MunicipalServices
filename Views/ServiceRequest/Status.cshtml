@model IEnumerable<MunicipalServices.Models.ServiceRequest>

@{
    ViewData["Title"] = "Service Request Status";
    var highestPriority = ViewBag.HighestPriority as MunicipalServices.Models.ServiceRequest;
}

<div class="container mt-4">
    <h2 class="mb-4 text-center fw-bold text-primary">🛠️ Service Request Status Tracker</h2>

    <!-- Statistics Bar -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white text-center">
                <div class="card-body">
                    <h3>@ViewBag.TotalRequests</h3>
                    <p class="mb-0">Total Requests</p>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            @if (highestPriority != null)
            {
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <h6 class="mb-1">⚡ Highest Priority Request</h6>
                        <a asp-action="Details" asp-route-id="@highestPriority.RequestId"
                           class="text-white text-decoration-none fw-bold">
                            <strong>@highestPriority.RequestId</strong> - @highestPriority.Title
                        </a>
                        <span class="badge bg-warning text-dark ms-2">Priority @highestPriority.Priority</span>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Search and Filter Bar -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <!-- Search by ID -->
                <div class="col-md-5">
                    <form asp-action="Status" method="get" class="d-flex gap-2">
                        <input type="text" name="searchId" class="form-control"
                               placeholder="Search by Request ID (uses BST)"
                               value="@ViewBag.SearchId" />
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </form>
                </div>

                <!-- Sort Options -->
                <div class="col-md-4">
                    <form asp-action="Status" method="get" class="d-flex gap-2 align-items-center">
                        <label class="fw-semibold mb-0">Sort by:</label>
                        <select name="sortBy" class="form-select" onchange="this.form.submit()">
                            @if (ViewBag.CurrentSort == "id")
                            {
                                <option value="id" selected>ID (BST)</option>
                            }
                            else
                            {
                                <option value="id">ID (BST)</option>
                            }

                            @if (ViewBag.CurrentSort == "priority")
                            {
                                <option value="priority" selected>Priority (AVL)</option>
                            }
                            else
                            {
                                <option value="priority">Priority (AVL)</option>
                            }

                            @if (ViewBag.CurrentSort == "date")
                            {
                                <option value="date" selected>Date (RB Tree)</option>
                            }
                            else
                            {
                                <option value="date">Date (RB Tree)</option>
                            }

                            @if (ViewBag.CurrentSort == "heap")
                            {
                                <option value="heap" selected>Urgent (Heap)</option>
                            }
                            else
                            {
                                <option value="heap">Urgent (Heap)</option>
                            }
                        </select>
                    </form>
                </div>

                <!-- View Options -->
                <div class="col-md-3">
                    <div class="btn-group w-100">
                        <a asp-action="DependencyGraph" class="btn btn-outline-secondary btn-sm">
                            📊 Dependencies
                        </a>
                        <a asp-action="TreeView" class="btn btn-outline-secondary btn-sm">
                            🌳 Tree View
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Requests Table -->
    @if (Model != null && Model.Any())
    {
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    Service Requests
                    @if (ViewBag.SearchPerformed == true)
                    {
                        <span class="badge bg-info">Search Results</span>
                        <a asp-action="Status" class="btn btn-sm btn-secondary ms-2">Clear</a>
                    }
                </h5>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Request ID</th>
                            <th>Title</th>
                            <th>Category</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Date Submitted</th>
                            <th>Location</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var request in Model)
                        {
                            <tr style="cursor: pointer;" onclick="window.location='@Url.Action("Details", "ServiceRequest", new { id = request.RequestId })'">
                                <td>
                                    <a asp-action="Details" asp-route-id="@request.RequestId"
                                       class="text-decoration-none fw-bold text-primary"
                                       onclick="event.stopPropagation();">
                                        <i class="bi bi-file-text"></i> @request.RequestId
                                    </a>
                                </td>
                                <td>
                                    <a asp-action="Details" asp-route-id="@request.RequestId"
                                       class="text-decoration-none text-dark"
                                       onclick="event.stopPropagation();">
                                        @request.Title
                                    </a>
                                </td>
                                <td><span class="badge bg-info">@request.Category</span></td>
                                <td>
                                    @switch (request.Status)
                                    {
                                        case MunicipalServices.Models.RequestStatus.Submitted:
                                            <span class="badge bg-secondary">Submitted</span>
                                            break;
                                        case MunicipalServices.Models.RequestStatus.InProgress:
                                            <span class="badge bg-primary">In Progress</span>
                                            break;
                                        case MunicipalServices.Models.RequestStatus.OnHold:
                                            <span class="badge bg-warning text-dark">On Hold</span>
                                            break;
                                        case MunicipalServices.Models.RequestStatus.Completed:
                                            <span class="badge bg-success">Completed</span>
                                            break;
                                        case MunicipalServices.Models.RequestStatus.Cancelled:
                                            <span class="badge bg-danger">Cancelled</span>
                                            break;
                                    }
                                </td>
                                <td>
                                    @if (request.Priority == 1)
                                    {
                                        <span class="badge bg-danger"><i class="bi bi-exclamation-triangle-fill"></i> High</span>
                                    }
                                    else if (request.Priority == 2)
                                    {
                                        <span class="badge bg-warning text-dark"><i class="bi bi-exclamation-circle"></i> Medium</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary"><i class="bi bi-dash-circle"></i> Low</span>
                                    }
                                </td>
                                <td>
                                    <i class="bi bi-calendar-event text-muted"></i>
                                    @request.DateSubmitted.ToShortDateString()
                                </td>
                                <td>
                                    <i class="bi bi-geo-alt-fill text-danger"></i>
                                    @request.Location
                                </td>
                                <td>
                                    <a asp-action="Details" asp-route-id="@request.RequestId"
                                       class="btn btn-sm btn-outline-primary"
                                       onclick="event.stopPropagation();">
                                        <i class="bi bi-eye"></i> View
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-warning text-center">
            <i class="bi bi-exclamation-triangle"></i> No service requests found.
            @if (ViewBag.SearchPerformed == true)
            {
                <p class="mb-0 mt-2">
                    <a asp-action="Status" class="btn btn-primary">View All Requests</a>
                </p>
            }
        </div>
    }

    <!-- Data Structure Info -->
    <div class="card mt-4 bg-light">
        <div class="card-body">
            <h6 class="fw-bold">🔧 Data Structures in Use:</h6>
            <div class="row">
                <div class="col-md-6">
                    <ul class="mb-0">
                        <li><strong>BST</strong> - Binary Search Tree for ID-based search (O(log n))</li>
                        <li><strong>AVL Tree</strong> - Self-balancing tree for priority ordering</li>
                        <li><strong>Red-Black Tree</strong> - Self-balancing tree for date ordering</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul class="mb-0">
                        <li><strong>Min-Heap</strong> - Priority queue for urgent requests</li>
                        <li><strong>Graph</strong> - Dependency tracking with BFS/DFS traversal</li>
                        <li><strong>MST</strong> - Minimum Spanning Tree for optimal dependencies</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Hover effect for table rows */
    tbody tr {
        transition: background-color 0.2s;
    }

        tbody tr:hover {
            background-color: #f8f9fa !important;
        }
</style>

@section Scripts {
    <script>
        // Add tooltips or additional interactivity here
        $(function () {
            $('[data-bs-toggle="tooltip"]').tooltip();
        });
    </script>
}